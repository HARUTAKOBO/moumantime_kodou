<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆå®Œæˆç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;padding:0;font-family:system-ui;background:#1e1e1e;color:#fff}
    h1{font-size:18px;margin:8px}
    .wrap{display:grid;grid-template-columns:260px 1fr;height:100vh}
    .panel{padding:12px;background:#2a2a2a;overflow:auto}
    label{font-size:12px;color:#ccc}
    input,button{width:100%;margin:6px 0;padding:6px}
    canvas{display:block;background:#000}
    button{cursor:pointer}
  </style>
</head>
<body>
<h1>ğŸ ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ãƒ»ãƒ«ãƒ¼ãƒˆå®Œå…¨å†ç¾ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
<div class="wrap">

<div class="panel">
  <label>æ™‚é–“åœ§ç¸®ï¼ˆã‚²ãƒ¼ãƒ ç§’/è¡¨ç¤ºç§’ï¼‰</label>
  <input id="scale" type="number" value="200">

  <label>åŸºæœ¬é€Ÿåº¦</label>
  <input id="baseSpeed" type="number" value="1389">

  <label>å®¿èˆå€ç‡</label>
  <input id="buffMult" type="number" value="5">

  <label>å®¿èˆãƒãƒ•æ™‚é–“ï¼ˆç§’ï¼‰</label>
  <input id="buffTime" type="number" value="900">

  <label>èœ‚ãƒ‡ãƒãƒ•å€ç‡</label>
  <input id="beeDebuff" type="number" step="0.1" value="0.7">

  <label>é­ãƒãƒ•å€ç‡</label>
  <input id="whipBuff" type="number" step="0.1" value="1.3">

  <button id="whip0">ğŸ‡ æ¡‚å·ã«é­</button>
  <button id="bee5">ğŸ å¯¿å·ã«èœ‚</button>
  <button id="reset">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<canvas id="field" width="900" height="1200"></canvas>

</div>

<script>
const canvas = document.getElementById('field');
const ctx = canvas.getContext('2d');

const scaleEl = document.getElementById('scale');
const baseSpeedEl = document.getElementById('baseSpeed');
const buffMultEl = document.getElementById('buffMult');
const buffTimeEl = document.getElementById('buffTime');
const beeDebuffEl = document.getElementById('beeDebuff');
const whipBuffEl = document.getElementById('whipBuff');

const bg = new Image();
bg.src = 'map.png'; // ãƒãƒƒãƒ—ç”»åƒ

const nodes = {
  start:{x:450,y:1030,type:'start'},
  a:{x:430,y:900,type:'inn'},
  b:{x:470,y:820,type:'inn'},
  c:{x:430,y:720,type:'inn'},
  fork1:{x:480,y:660,type:'fork'},
  d1:{x:420,y:580,type:'inn'},
  d2:{x:540,y:580,type:'inn'},
  merge1:{x:480,y:500,type:'merge'},
  e:{x:480,y:420,type:'inn'},
  goal:{x:460,y:220,type:'goal'}
};

const routes = [
 {name:'æ¡‚å·',path:['start','a','b','c','fork1','d1','merge1','e','goal'],mod:1.0},
 {name:'å¯¿å·',path:['start','a','b','c','fork1','d2','merge1','e','goal'],mod:1.0},
 {name:'æ±Ÿå·',path:['start','a','b','c','fork1','d2','merge1','e','goal'],mod:1.08},
 {name:'æ¶ªå·',path:['start','a','b','c','fork1','d1','merge1','e','goal'],mod:1.0},
 {name:'æ°¸å·',path:['start','a','b','c','fork1','d1','merge1','e','goal'],mod:1.0},
 {name:'å…‰å·',path:['start','a','b','c','fork1','d2','merge1','e','goal'],mod:1.0}
];

let horses = [];
let last = performance.now();

function resetSim(){
  horses = routes.map(r=>({
    route:r,
    seg:0,
    t:0,
    pos:{...nodes[r.path[0]]},
    bee:1,
    whip:1,
    buffRemain: r.path.filter(n=>nodes[n].type==='inn').length * Number(buffTimeEl.value)
  }));
}

function safeHorse(i){ return horses[i] ?? null; }

function useBee(i){
  const h = safeHorse(i);
  if(!h) return;
  h.bee = Number(beeDebuffEl.value);
  setTimeout(()=>{ h.bee = 1; },3000);
}

function useWhip(i){
  const h = safeHorse(i);
  if(!h) return;
  h.whip = Number(whipBuffEl.value);
  setTimeout(()=>{ h.whip = 1; },3000);
}

function tick(now){
  const dt = (now-last)/1000; last = now;
  const scaleV = Number(scaleEl.value);

  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(bg.complete && bg.naturalWidth>0){
    ctx.drawImage(bg,0,0,canvas.width,canvas.height);
  } else {
    // èƒŒæ™¯ãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã®ä»®è¡¨ç¤º
    ctx.fillStyle = '#203040';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = '#304860';
    for(let x=0;x<canvas.width;x+=100){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
    for(let y=0;y<canvas.height;y+=100){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
    ctx.fillStyle='#fff';
    ctx.fillText('âš  map.jpg ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“',20,30);
    ctx.fillText('HTMLã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« map.jpg ã‚’ç½®ã„ã¦ãã ã•ã„',20,50);
  }

  horses.forEach(h=>{
    if(h.seg >= h.route.path.length-1) return;

    let speed = Number(baseSpeedEl.value) * h.route.mod * h.bee * h.whip;
    if(h.buffRemain > 0){
      speed *= Number(buffMultEl.value);
      h.buffRemain -= dt * scaleV;
    }

    const from = nodes[h.route.path[h.seg]];
    const to = nodes[h.route.path[h.seg+1]];
    const dx = to.x - from.x;
    const dy = to.y - from.y;
    const dist = Math.hypot(dx,dy) || 1;

    h.t += (speed * dt * scaleV) / dist;

    if(h.t >= 1){
      h.seg++;
      h.t = 0;
      const node = nodes[h.route.path[h.seg]];
      if(node && node.type==='inn'){
        h.buffRemain += Number(buffTimeEl.value);
      }
    }

    h.pos.x = from.x + dx * h.t;
    h.pos.y = from.y + dy * h.t;

    ctx.fillStyle='yellow';
    ctx.beginPath(); ctx.arc(h.pos.x,h.pos.y,6,0,Math.PI*2); ctx.fill();
    ctx.fillText(h.route.name,h.pos.x+8,h.pos.y);
  });

  requestAnimationFrame(tick);
}

// ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆhorsesæœªåˆæœŸåŒ–å¯¾ç­–ï¼‰
document.getElementById('reset').onclick = ()=>resetSim();
document.getElementById('whip0').onclick = ()=>useWhip(0);
document.getElementById('bee5').onclick = ()=>useBee(5);

// èƒŒæ™¯ç”»åƒã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
resetSim();
requestAnimationFrame(tick);

// ç”»åƒãŒèª­ã¿è¾¼ã‚ãŸã‚‰æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰åæ˜ 
bg.onload = ()=>{
  // ä½•ã‚‚ã—ãªãã¦ã‚‚æ¬¡ã® tick ã§æç”»ã•ã‚Œã‚‹
};
</script>
</body>
</html>
