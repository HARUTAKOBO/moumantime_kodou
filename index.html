<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ å®Œæˆç‰ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{margin:0;font-family:system-ui;background:#111;color:#fff}
h1{font-size:16px;margin:8px}
.wrap{display:grid;grid-template-columns:360px 1fr;height:100vh}
.panel{background:#222;padding:12px;overflow:auto}
button,input{width:100%;margin:4px 0;padding:6px}
label{font-size:12px;color:#ccc}
canvas{background:#000;touch-action:none}
hr{border:0;border-top:1px solid #444;margin:8px 0}
.table{font-size:12px}
.table div{display:flex;justify-content:space-between}
.bar{height:6px;background:#444;margin:2px 0}
.bar span{display:block;height:100%}
</style>
</head>
<body>
<h1>ğŸ ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ï½œå®Œæˆç‰ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
<div class="wrap">
<div class="panel">
<strong>å…¨ä½“è¨­å®š</strong>
<label>ç·è·é›¢</label><input id="totalDist" type="number" value="50000000">
<label>åˆæœŸãƒ©ã‚¤ãƒ</label><input id="initLychee" type="number" value="10600000">
<label>ãƒ©ã‚¤ãƒæ¸›å°‘/ç§’</label><input id="lycheeLoss" type="number" value="100">
<label>åŸºæœ¬é€Ÿåº¦(px/step)</label><input id="baseSpeed" type="number" value="1">
<hr>
<strong>ãƒ«ãƒ¼ãƒˆè·é›¢è¨­å®š</strong>
<div id="routeInputs"></div>
<hr>
<button onclick="startSim()">â–¶ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</button>
<button onclick="resetSim()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
<hr>
<strong>è·é›¢ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</strong>
<div id="distInfo" class="table"></div>
<hr>
<strong>ãƒ©ã‚¤ãƒã‚²ãƒ¼ã‚¸</strong>
<div id="lycheeBars"></div>
</div>
<canvas id="field" width="900" height="1200"></canvas>
</div>
<script>
// ===== åŸºæœ¬ =====
const canvas=document.getElementById('field');
const ctx=canvas.getContext('2d');
const bg=new Image(); bg.src='map.png';
const teams=['æ¡‚å·','å¯¿å·','æ±Ÿå·','æ¶ªå·','æ°¸å·','å…‰å·'];
const colors={æ¡‚å·:'#ff4d4d',å¯¿å·:'#4dff4d',æ±Ÿå·:'#4d4dff',æ¶ªå·:'#ffd24d',æ°¸å·:'#ff4dff',å…‰å·:'#4dffff'};

let nodes=[]; // æ—¢å­˜ã‚¨ãƒ‡ã‚£ã‚¿ã§é…ç½®æ¸ˆã¿å‰æ
let horses=[]; let running=false; let lastTime=null;

// ===== ãƒ«ãƒ¼ãƒˆè·é›¢UI =====
const routeInputs=document.getElementById('routeInputs');
const routeDist={};
teams.forEach(t=>{
  routeDist[t]=50000000;
  const d=document.createElement('div');
  d.innerHTML=`<label>${t}</label><input type="number" value="${routeDist[t]}" onchange="routeDist['${t}']=Number(this.value)">`;
  routeInputs.appendChild(d);
});

// ===== è·é›¢è¨ˆç®— =====
function calcRouteDistance(team){
  const path=nodes.filter(n=>n.teams?.includes(team)).sort((a,b)=>{
    if(a.type==='start')return-1;if(b.type==='start')return 1;
    if(a.type==='goal')return 1;if(b.type==='goal')return -1;
    return b.y-a.y;
  });
  let d=0;
  for(let i=0;i<path.length-1;i++){
    d+=Math.hypot(path[i+1].x-path[i].x,path[i+1].y-path[i].y);
  }
  return d;
}

function updateDistInfo(){
  const box=document.getElementById('distInfo');box.innerHTML='';
  teams.forEach(t=>{
    const v=calcRouteDistance(t).toFixed(1);
    const r=document.createElement('div');r.innerHTML=`<span>${t}</span><span>${v}</span>`;
    box.appendChild(r);
  });
}

// ===== ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ =====
function startSim(){
  const baseSpeed=Number(document.getElementById('baseSpeed').value);
  const totalDist=Number(document.getElementById('totalDist').value);
  const initLychee=Number(document.getElementById('initLychee').value);
  const loss=Number(document.getElementById('lycheeLoss').value);

  horses=teams.map(t=>{
    const path=nodes.filter(n=>n.teams?.includes(t)).sort((a,b)=>{
      if(a.type==='start')return-1;if(b.type==='start')return 1;
      if(a.type==='goal')return 1;if(b.type==='goal')return -1;
      return b.y-a.y;
    });
    const pxDist=calcRouteDistance(t)||1;
    const scale=routeDist[t]/pxDist;
    return {team:t,color:colors[t],path,idx:0,prog:0,speed:baseSpeed*scale,lychee:initLychee,loss};
  });
  running=true; lastTime=performance.now();
}

function resetSim(){running=false;horses=[];lastTime=null;}

function draw(now){
  ctx.fillStyle='#203040';ctx.fillRect(0,0,canvas.width,canvas.height);
  if(bg.complete)ctx.drawImage(bg,0,0,canvas.width,canvas.height);

  updateDistInfo();

  if(running&&lastTime){
    const dt=(now-lastTime)/1000; lastTime=now;
    horses.forEach(h=>{
      if(h.idx>=h.path.length-1)return;
      h.lychee=Math.max(0,h.lychee-dt*h.loss);
      const a=h.path[h.idx],b=h.path[h.idx+1];
      const seg=Math.hypot(b.x-a.x,b.y-a.y)||1;
      h.prog+=h.speed*dt/seg;
      if(h.prog>=1){h.idx++;h.prog=0;if(b.type?.includes('inn'))h.speed*=5;}
      h.x=a.x+(b.x-a.x)*h.prog;h.y=a.y+(b.y-a.y)*h.prog;
      ctx.fillStyle=h.color;ctx.beginPath();ctx.arc(h.x,h.y,10,0,Math.PI*2);ctx.fill();
    });
    drawLychee();
  }
  requestAnimationFrame(draw);
}

function drawLychee(){
  const box=document.getElementById('lycheeBars');box.innerHTML='';
  const max=Number(document.getElementById('initLychee').value);
  horses.forEach(h=>{
    const d=document.createElement('div');
    const bar=document.createElement('div');bar.className='bar';
    const span=document.createElement('span');span.style.width=(h.lychee/max*100)+'%';span.style.background=h.color;
    bar.appendChild(span);
    d.innerHTML=`<div>${h.team}: ${Math.floor(h.lychee)}</div>`;
    d.appendChild(bar);box.appendChild(d);
  });
}

requestAnimationFrame(draw);
</script>
</body>
</html>
