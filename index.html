<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ STEP3ï¼ˆãƒ«ãƒ¼ãƒˆï¼‹åˆ†å²ï¼‹å®¿èˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{margin:0;font-family:system-ui;background:#111;color:#fff}
h1{font-size:16px;margin:8px}
.wrap{display:grid;grid-template-columns:260px 1fr;height:100vh}
.panel{background:#222;padding:12px;overflow:auto}
label{font-size:12px;color:#ccc}
input,button{width:100%;margin:6px 0;padding:6px}
canvas{background:#000}
</style>
</head>
<body>
<h1>ğŸ STEP3ï¼šãƒ«ãƒ¼ãƒˆãƒ»åˆ†å²ãƒ»å®¿èˆã¤ãã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
<div class="wrap">
<div class="panel">
<label>æ™‚é–“åœ§ç¸®</label>
<input id="scale" type="number" value="5">
<label>ãƒãƒƒãƒ—é€æ˜åº¦</label>
<input id="alpha" type="number" step="0.1" min="0" max="1" value="0.6">
<button id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
<p style="font-size:12px;line-height:1.4">
ãƒ»6è‰²ã®ä¸¸ãŒãƒ«ãƒ¼ãƒˆã«æ²¿ã£ã¦é€²ã‚€<br>
ãƒ»ç™½ã„å††ï¼å®¿èˆï¼ˆé€šéã§åŠ é€Ÿï¼‰
</p>
</div>
<canvas id="field" width="900" height="1200"></canvas>
</div>
<script>
// ===== STEP3 æœ¬å‘½ =====
const canvas = document.getElementById('field');
const ctx = canvas.getContext('2d');
const scaleEl = document.getElementById('scale');
const alphaEl = document.getElementById('alpha');

const bg = new Image();
bg.src = 'map.png';

// ãƒãƒ¼ãƒ‰ï¼ˆç›®è¦–é…ç½®ãƒ»å¾Œã§å¾®èª¿æ•´OKï¼‰
const nodes = {
  start:{x:450,y:1030},
  a:{x:430,y:900},
  b:{x:470,y:820},
  c:{x:430,y:720},
  fork:{x:480,y:660},
  d1:{x:420,y:580},
  d2:{x:540,y:580},
  merge:{x:480,y:500},
  e:{x:480,y:420},
  goal:{x:460,y:220}
};

// å®¿èˆãƒãƒ¼ãƒ‰
const inns = ['a','b','c','d1','d2','e'];

// 6ãƒ«ãƒ¼ãƒˆ
const routes = [
  {name:'æ¡‚å·', color:'#ff4d4d', path:['start','a','b','c','fork','d1','merge','e','goal']},
  {name:'å¯¿å·', color:'#4dff4d', path:['start','a','b','c','fork','d2','merge','e','goal']},
  {name:'æ±Ÿå·', color:'#4d4dff', path:['start','a','b','c','fork','d2','merge','e','goal']},
  {name:'æ¶ªå·', color:'#ffd24d', path:['start','a','b','c','fork','d1','merge','e','goal']},
  {name:'æ°¸å·', color:'#ff4dff', path:['start','a','b','c','fork','d1','merge','e','goal']},
  {name:'å…‰å·', color:'#4dffff', path:['start','a','b','c','fork','d2','merge','e','goal']}
];

let horses=[];

function resetSim(){
  horses = routes.map(r=>({
    route:r,
    seg:0,
    t:0,
    speed:1,
    buff:0,
    pos:{...nodes[r.path[0]]}
  }));
}

function draw(){
  ctx.fillStyle='#203040';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(bg.complete && bg.naturalWidth>0){
    ctx.save();
    ctx.globalAlpha = Number(alphaEl.value);
    ctx.drawImage(bg,0,0,canvas.width,canvas.height);
    ctx.restore();
  }

  // å®¿èˆè¡¨ç¤º
  inns.forEach(k=>{
    const n = nodes[k];
    ctx.strokeStyle='#fff';
    ctx.beginPath();
    ctx.arc(n.x,n.y,8,0,Math.PI*2);
    ctx.stroke();
  });

  // é¦¬
  horses.forEach(h=>{
    if(h.seg >= h.route.path.length-1) return;
    const from = nodes[h.route.path[h.seg]];
    const to   = nodes[h.route.path[h.seg+1]];
    const dx = to.x-from.x;
    const dy = to.y-from.y;
    const dist = Math.hypot(dx,dy);

    let v = 0.5;
    if(h.buff>0){ v = 2; h.buff--; }

    h.t += v * Number(scaleEl.value) / dist;

    if(h.t>=1){
      h.seg++;
      h.t=0;
      const nodeName = h.route.path[h.seg];
      if(inns.includes(nodeName)){
        h.buff = 300; // å®¿èˆãƒãƒ•ï¼ˆè¦–è¦šç”¨ï¼‰
      }
    }

    h.pos.x = from.x + dx*h.t;
    h.pos.y = from.y + dy*h.t;

    ctx.fillStyle=h.route.color;
    ctx.beginPath();
    ctx.arc(h.pos.x,h.pos.y,10,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle='#000';
    ctx.fillText(h.route.name,h.pos.x+12,h.pos.y);
  });

  requestAnimationFrame(draw);
}

resetSim();
requestAnimationFrame(draw);

document.getElementById('reset').onclick = resetSim;
</script>
</body>
</html>
