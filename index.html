<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ï½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‹</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{margin:0;font-family:system-ui;background:#111;color:#fff}
h1{font-size:16px;margin:8px}
.wrap{display:grid;grid-template-columns:360px 1fr;height:100vh}
.panel{background:#222;padding:10px;overflow:auto}
button,input{width:100%;margin:3px 0;padding:6px}
canvas{background:#000}
hr{border:0;border-top:1px solid #444;margin:8px 0}

.keypad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:4px;
  margin-bottom:6px;
}
.active{background:#0aa !important}

.small{font-size:12px;color:#ccc}
.bar{height:6px;background:#444}
.bar span{display:block;height:100%}
</style>
</head>

<body>
<h1>ğŸ§­ ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ï½œã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‹</h1>

<div class="wrap">
<div class="panel">

<strong>å…±é€šãƒãƒ¼ãƒ‰</strong>
<div class="keypad">
  <button onclick="setType('start')">START</button>
  <button onclick="setType('goal')">GOAL</button>
</div>

<hr>

<strong>ãƒãƒ¼ãƒ‰ç¨®åˆ¥</strong>
<div class="keypad">
  <button onclick="setType('inn_small')">å°å®¿</button>
  <button onclick="setType('inn_big')">å¤§å®¿</button>
  <button onclick="setType('fork')">åˆ†å²</button>
  <button onclick="setType('merge')">åˆæµ</button>
</div>

<strong>éƒ½å¸‚é¸æŠ</strong>
<div class="keypad">
  <button onclick="setCity('æ¡‚å·')">æ¡‚å·</button>
  <button onclick="setCity('å¯¿å·')">å¯¿å·</button>
  <button onclick="setCity('æ±Ÿå·')">æ±Ÿå·</button>
  <button onclick="setCity('æ¶ªå·')">æ¶ªå·</button>
  <button onclick="setCity('æ°¸å·')">æ°¸å·</button>
  <button onclick="setCity('å…‰å·')">å…‰å·</button>
</div>

<hr>

<strong>åŸºæœ¬è¨­å®š</strong>
<label>ç·è·é›¢</label><input id="totalDist" type="number" value="50000000">
<label>åŸºæœ¬é€Ÿåº¦</label><input id="baseSpeed" type="number" value="1389">
<label>åˆæœŸãƒ©ã‚¤ãƒ</label><input id="initLychee" type="number" value="10600000">
<label>ãƒ©ã‚¤ãƒæ¸›å°‘/ç§’</label><input id="loss" type="number" value="100">

<hr>

<button onclick="runSim()">â–¶ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
<button onclick="resetSim()">â†º ãƒªã‚»ãƒƒãƒˆ</button>
<button onclick="deleteSelected()">ğŸ—‘ é¸æŠãƒãƒ¼ãƒ‰å‰Šé™¤</button>

<hr>
<strong>çµæœ</strong>
<div id="result"></div>

</div>

<canvas id="field" width="900" height="1200"></canvas>
</div>

<script>
const canvas=document.getElementById('field');
const ctx=canvas.getContext('2d');
const bg=new Image(); bg.src='map.png';

const cities=['æ¡‚å·','å¯¿å·','æ±Ÿå·','æ¶ªå·','æ°¸å·','å…‰å·'];
const colors={æ¡‚å·:'#ff4d4d',å¯¿å·:'#4dff4d',æ±Ÿå·:'#4d4dff',æ¶ªå·:'#ffd24d',æ°¸å·:'#ff4dff',å…‰å·:'#4dffff'};

let nodes=[];
let selected=null, drag=null;
let currentType=null, currentCity=null;

let simulated=false;
let simResult={};

function setType(t){ currentType=t; highlight(); }
function setCity(c){ currentCity=c; highlight(); }

function highlight(){
  document.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('button').forEach(b=>{
    if(b.innerText===currentType||b.innerText===currentCity) b.classList.add('active');
  });
}

function addNode(x,y){
  if(!currentType||!currentCity) return;
  nodes.push({id:Date.now()+Math.random(),x,y,type:currentType,city:currentCity});
}

function deleteSelected(){
  if(!selected) return;
  nodes=nodes.filter(n=>n!==selected);
  selected=null;
}

function routeNodes(city){
  return nodes
    .filter(n=>n.city===city||n.city==='all')
    .sort((a,b)=>{
      if(a.type==='start') return -1;
      if(b.type==='start') return 1;
      if(a.type==='goal') return 1;
      if(b.type==='goal') return -1;
      return a.id-b.id;
    });
}

function calc(city){
  const path=routeNodes(city);
  if(path.length<2) return null;
  let px=0;
  for(let i=0;i<path.length-1;i++){
    px+=Math.hypot(path[i+1].x-path[i].x,path[i+1].y-path[i].y);
  }
  const dist=+totalDist.value;
  const speed=+baseSpeed.value;
  const time=dist/speed;
  const ly0=+initLychee.value;
  const loss=+loss.value;
  return {time, ly:Math.max(0, ly0-time*loss)};
}

function runSim(){
  simResult={};
  cities.forEach(c=>{
    const r=calc(c);
    if(r) simResult[c]=r;
  });
  simulated=true;
}

function resetSim(){
  simulated=false;
  simResult={};
  document.getElementById('result').innerHTML='';
}

function drawResult(){
  if(!simulated) return;
  const r=document.getElementById('result');
  r.innerHTML='';
  const ly0=+initLychee.value;

  cities.forEach(c=>{
    const v=simResult[c];
    if(!v) return;
    const d=document.createElement('div');
    d.innerHTML=`
      <div class="small">${c} ${v.time.toFixed(0)}ç§’ / ${Math.floor(v.ly)}</div>
      <div class="bar">
        <span style="width:${v.ly/ly0*100}%;background:${colors[c]}"></span>
      </div>`;
    r.appendChild(d);
  });
}

function draw(){
  ctx.fillStyle='#203040';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  if(bg.complete) ctx.drawImage(bg,0,0,canvas.width,canvas.height);

  nodes.forEach(n=>{
    let c=colors[n.city]||'#fff';
    if(n.type==='start') c='#0f0';
    if(n.type==='goal') c='#f00';
    ctx.fillStyle=n===selected?'#0ff':c;
    ctx.beginPath();
    ctx.arc(n.x,n.y,8,0,Math.PI*2);
    ctx.fill();
  });

  drawResult();
  requestAnimationFrame(draw);
}

function pos(e){
  const r=canvas.getBoundingClientRect();
  return {x:e.clientX-r.left,y:e.clientY-r.top};
}

canvas.onmousedown=e=>{
  const m=pos(e);
  selected=null;
  for(const n of nodes){
    if(Math.hypot(n.x-m.x,n.y-m.y)<10){
      selected=n; drag=n; return;
    }
  }
  if(!simulated) addNode(m.x,m.y);
};
canvas.onmousemove=e=>{
  if(drag&&!simulated){
    const m=pos(e);
    drag.x=m.x; drag.y=m.y;
  }
};
canvas.onmouseup=()=>drag=null;

draw();
</script>
</body>
</html>
