<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ライチ争奪戦｜整理後仕様版</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0f1220;
  color:#fff;
  font-family:system-ui;
}
.wrap{
  display:grid;
  grid-template-columns:440px 1fr;
  height:100vh;
}
.panel{
  background:#1b1f3b;
  padding:12px;
  overflow:auto;
}
canvas{background:#000}

/* buttons */
button{
  padding:8px 6px;
  border:none;
  border-radius:12px;
  background:#3a3f6b;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:.15s;
}
button:hover{filter:brightness(1.1)}
button.active{
  background:linear-gradient(180deg,#ffd86b,#ffb703);
  color:#000;
}

/* grids */
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.grid6{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}

/* inputs */
label{font-size:11px;color:#ccc}
input{
  width:100%;
  padding:6px;
  border-radius:8px;
  border:none;
  background:#2a2f55;
  color:#fff;
  text-align:right;
}
.field{margin-bottom:6px}
</style>
</head>

<body>
<div class="wrap">

<!-- ===== 左パネル ===== -->
<div class="panel">

<div class="grid3">
  <button onclick="setType('start')">スタート</button>
  <button onclick="setType('goal')">ゴール</button>
  <button onclick="runSim()">▶ シミュレーション</button>
</div>

<h3>都市（最大2つ）</h3>
<div class="grid6" id="cityButtons"></div>

<h3>ノード種別</h3>
<div class="grid3">
  <button onclick="setType('inn_small')">小宿</button>
  <button onclick="setType('inn_big')">大宿</button>
</div>

<h3>基本設定</h3>
<div class="field"><label>総距離</label><input id="totalDist" value="50000000"></div>
<div class="field"><label>基本速度/秒</label><input id="baseSpeed" value="1389"></div>
<div class="field"><label>初期ライチ数</label><input id="initLychee" value="10600000"></div>
<div class="field"><label>ライチ減少数/秒</label><input id="loss" value="100"></div>

</div>

<!-- ===== マップ ===== -->
<canvas id="field" width="900" height="1200"></canvas>

</div>

<script>
const canvas=document.getElementById('field');
const ctx=canvas.getContext('2d');
const bg=new Image(); bg.src='map.png';

const cities=['涪州','桂州','永州','江州','光州','寿州'];
const colors={
  涪州:'#ff6b6b',桂州:'#ffd93d',永州:'#6bff95',
  江州:'#6ba8ff',光州:'#ff6bf0',寿州:'#6bfff5'
};

let nodes=[];
let currentType=null;
let selectedCities=[];

/* ---- city buttons ---- */
const cityBox=document.getElementById('cityButtons');
cities.forEach(c=>{
  const b=document.createElement('button');
  b.textContent=c;
  b.onclick=()=>toggleCity(c);
  cityBox.appendChild(b);
});

function toggleCity(city){
  const singleOnly = (currentType==='start'||currentType==='goal');
  if(singleOnly){
    selectedCities=[city];
  }else{
    if(selectedCities.includes(city)){
      selectedCities=selectedCities.filter(c=>c!==city);
    }else if(selectedCities.length<2){
      selectedCities.push(city);
    }
  }
  refreshCityButtons();
}

function refreshCityButtons(){
  [...cityBox.children].forEach(b=>{
    if(selectedCities.includes(b.textContent)){
      b.classList.add('active');
      b.style.background=colors[b.textContent];
      b.style.color='#000';
    }else{
      b.classList.remove('active');
      b.style.background='';
      b.style.color='';
    }
  });
}

/* ---- node type ---- */
function setType(t){
  currentType=t;
  selectedCities=[];
  document.querySelectorAll('.grid3 button').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  refreshCityButtons();
}

/* ---- add node ---- */
canvas.onmousedown=e=>{
  if(!currentType||selectedCities.length===0) return;
  const r=canvas.getBoundingClientRect();
  nodes.push({
    x:e.clientX-r.left,
    y:e.clientY-r.top,
    type:currentType,
    cities:[...selectedCities]
  });
};

/* ---- draw ---- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(bg.complete) ctx.drawImage(bg,0,0,canvas.width,canvas.height);

  nodes.forEach(n=>{
    if(n.cities.length===1){
      ctx.fillStyle=colors[n.cities[0]];
      ctx.beginPath();
      ctx.arc(n.x,n.y,8,0,Math.PI*2);
      ctx.fill();
    }else{
      ctx.lineWidth=4;
      ctx.strokeStyle=colors[n.cities[0]];
      ctx.beginPath();
      ctx.arc(n.x,n.y,10,0,Math.PI);
      ctx.stroke();
      ctx.strokeStyle=colors[n.cities[1]];
      ctx.beginPath();
      ctx.arc(n.x,n.y,10,Math.PI,Math.PI*2);
      ctx.stroke();
    }
  });

  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
