<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆé…ç½®â†’å®Ÿè¡Œï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{margin:0;font-family:system-ui;background:#111;color:#fff}
h1{font-size:16px;margin:8px}
.wrap{display:grid;grid-template-columns:320px 1fr;height:100vh}
.panel{background:#222;padding:12px;overflow:auto}
button{width:100%;margin:4px 0;padding:6px}
label{font-size:12px;color:#ccc}
canvas{background:#000;touch-action:none}
hr{border:0;border-top:1px solid #444;margin:8px 0}
</style>
</head>
<body>
<h1>ğŸ ãƒ©ã‚¤ãƒäº‰å¥ªæˆ¦ï½œé…ç½®â†’6ãƒãƒ¼ãƒ åŒæ™‚ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
<div class="wrap">
<div class="panel">
<strong>ãƒãƒ¼ãƒ‰è¿½åŠ </strong>
<div style="margin-bottom:6px">ç¾åœ¨ã®é…ç½®ãƒ¢ãƒ¼ãƒ‰ï¼š<span id="placeMode">ãªã—</span></div>
<button onclick="setPlaceMode('start')">ğŸ“ ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é€£ç¶šé…ç½®</button>
<button onclick="setPlaceMode('inn_small')">ğŸ“ å°å®¿ã‚’é€£ç¶šé…ç½®</button>
<button onclick="setPlaceMode('inn_big')">ğŸ“ å¤§å®¿ã‚’é€£ç¶šé…ç½®</button>
<button onclick="setPlaceMode('fork')">ğŸ“ åˆ†å²ã‚’é€£ç¶šé…ç½®</button>
<button onclick="setPlaceMode('merge')">ğŸ“ åˆæµã‚’é€£ç¶šé…ç½®</button>
<button onclick="setPlaceMode('goal')">ğŸ“ ã‚´ãƒ¼ãƒ«ã‚’é€£ç¶šé…ç½®</button>
<button onclick="clearPlaceMode()">â›” é…ç½®ãƒ¢ãƒ¼ãƒ‰è§£é™¤</button>
<hr>
<button onclick="startSim()">â–¶ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</button>
<button onclick="resetSim()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
<hr>
<label>æ™‚é–“å€ç‡</label>
<input id="scale" type="number" value="5">
<hr>
<strong>é¸æŠãƒãƒ¼ãƒ‰</strong><br>
<span id="sel">ãªã—</span>
<div id="nodeOptions"></div>
</div>
<canvas id="field" width="900" height="1200"></canvas>
</div>
<script>
// ===== å…±é€š =====
const canvas=document.getElementById('field');
const ctx=canvas.getContext('2d');
const bg=new Image(); bg.src='map.png';
const scaleEl=document.getElementById('scale');
const teams=['æ¡‚å·','å¯¿å·','æ±Ÿå·','æ¶ªå·','æ°¸å·','å…‰å·'];
let nodes=[]; let selected=null; let drag=null;
let placeMode=null; // é€£ç¶šé…ç½®ãƒ¢ãƒ¼ãƒ‰
let horses=[]; let running=false;

function addNode(type,x=450,y=600){
  nodes.push({id:Date.now()+Math.random(),x,y,type,teams:[...teams]});
}

function setPlaceMode(type){
  placeMode = type;
  document.getElementById('placeMode').textContent = type;
}
function clearPlaceMode(){
  placeMode = null;
  document.getElementById('placeMode').textContent = 'ãªã—';
});
}

function resetSim(){ running=false; horses=[]; }

function startSim(){
  // å„ãƒãƒ¼ãƒ ç”¨ã«ã€é€šéãƒãƒ¼ãƒ‰ã‚’Yé †ã§æŠ½å‡º
  horses = teams.map((t,i)=>{
    const path = nodes
      .filter(n=>n.teams.includes(t))
      .sort((a,b)=>{
        // start ã¯å¿…ãšæœ€åˆã€goal ã¯å¿…ãšæœ€å¾Œ
        if(a.type==='start') return -1;
        if(b.type==='start') return 1;
        if(a.type==='goal') return 1;
        if(b.type==='goal') return -1;
        // ãã‚Œä»¥å¤–ã¯ Y åº§æ¨™ï¼ˆä¸‹â†’ä¸Šï¼‰ã§é †åºæ±ºå®š
        return b.y - a.y;
      }); // ä¸‹â†’ä¸Š
    return {team:t,color:colors[t],path,idx:0,t:0,x:path[0]?.x||0,y:path[0]?.y||0,speed:1};
  });
  running=true;
}

const colors={æ¡‚å·:'#ff4d4d',å¯¿å·:'#4dff4d',æ±Ÿå·:'#4d4dff',æ¶ªå·:'#ffd24d',æ°¸å·:'#ff4dff',å…‰å·:'#4dffff'};

function draw(){
  ctx.fillStyle='#203040'; ctx.fillRect(0,0,canvas.width,canvas.height);
  if(bg.complete && bg.naturalWidth>0) ctx.drawImage(bg,0,0,canvas.width,canvas.height);

  // ãƒãƒ¼ãƒ‰è¡¨ç¤º
  nodes.forEach(n=>{
    let c='#fff';
    if(n.type==='start')c='#0f0'; if(n.type==='goal')c='#f00';
    if(n.type==='inn_small')c='#aaa'; if(n.type==='inn_big')c='#ffd700';
    if(n.type==='fork')c='#0ff'; if(n.type==='merge')c='#f0f';
    ctx.fillStyle=n===selected?'#0ff':c;
    ctx.beginPath(); ctx.arc(n.x,n.y,8,0,Math.PI*2); ctx.fill();
  });

  // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  if(running){
    horses.forEach(h=>{
      if(h.idx>=h.path.length-1) return;
      const from=h.path[h.idx]; const to=h.path[h.idx+1];
      const dx=to.x-from.x, dy=to.y-from.y;
      const dist=Math.hypot(dx,dy)||1;
      h.t += h.speed*Number(scaleEl.value)/dist;
      if(h.t>=1){ h.idx++; h.t=0; if(to.type.includes('inn')) h.speed=3; }
      h.x=from.x+dx*h.t; h.y=from.y+dy*h.t;
      ctx.fillStyle=colors[h.team];
      ctx.beginPath(); ctx.arc(h.x,h.y,10,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#000'; ctx.fillText(h.team,h.x+12,h.y);
    });
  }

  requestAnimationFrame(draw);
}

// ===== æ“ä½œ =====
function getPos(e){const r=canvas.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}
canvas.onmousedown=e=>{
  const m=getPos(e);
  selected=null;

  // é€£ç¶šé…ç½®ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ¼ãƒ‰è¿½åŠ 
  if(placeMode){
    addNode(placeMode,m.x,m.y);
    return;
  }

  // é€šå¸¸é¸æŠãƒ»ãƒ‰ãƒ©ãƒƒã‚°
  for(const n of nodes){
    if(Math.hypot(n.x-m.x,n.y-m.y)<10){
      selected=n;drag=n;break;
    }
  }
  updatePanel();
}
canvas.onmousemove=e=>{if(drag){const m=getPos(e);drag.x=m.x;drag.y=m.y}}
canvas.onmouseup=()=>drag=null;

function updatePanel(){
  const sel=document.getElementById('sel'); const opt=document.getElementById('nodeOptions');
  sel.textContent=selected?selected.type:'ãªã—'; opt.innerHTML='';
  if(!selected) return;
  teams.forEach(t=>{
    const c=document.createElement('input');c.type='checkbox';c.checked=selected.teams.includes(t);
    c.onchange=()=>{ if(c.checked&&!selected.teams.includes(t))selected.teams.push(t);
      if(!c.checked)selected.teams=selected.teams.filter(x=>x!==t); };
    opt.append(c,' ',t,document.createElement('br'));
  });
}

draw();
</script>
</body>
</html>
