<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ライチ争奪戦｜UI改善版</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0f1220;
  color:#fff;
  font-family:"Segoe UI",system-ui;
}

/* ===== レイアウト ===== */
.wrap{
  display:grid;
  grid-template-columns:420px 1fr;
  height:100vh;
}
.panel{
  background:linear-gradient(180deg,#1b1f3b,#14172a);
  padding:12px;
  overflow:auto;
  z-index:10;
}
canvas{
  background:#000;
  display:block;
}

/* ===== UI ===== */
h2{
  font-size:14px;
  margin:10px 0 6px;
  color:#ffd86b;
}
.grid3,.grid6{
  display:grid;
  gap:6px;
}
.grid3{grid-template-columns:repeat(3,1fr)}
.grid6{grid-template-columns:repeat(6,1fr)}

.field{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap:2px;
}
label{
  font-size:11px;
  color:#ccc;
}
input{
  padding:6px;
  border-radius:8px;
  border:none;
  background:#2a2f55;
  color:#fff;
  text-align:right;
}

/* ===== 可愛いボタン ===== */
button{
  padding:8px 6px;
  border:none;
  border-radius:12px;
  background:linear-gradient(180deg,#4d6bff,#3546c8);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:.15s;
  box-shadow:0 4px 0 #24339a;
}
button:hover{
  filter:brightness(1.1);
}
button:active{
  transform:translateY(3px);
  box-shadow:0 1px 0 #24339a;
}

/* ===== 結果 ===== */
.result{
  display:grid;
  grid-template-columns:40px 60px 1fr 60px 80px 60px;
  gap:4px;
  font-size:12px;
}
.cell{
  background:#2a2f55;
  border-radius:8px;
  padding:4px;
  text-align:center;
}
.bar{
  height:6px;
  background:#444;
  border-radius:4px;
  overflow:hidden;
}
.bar span{display:block;height:100%}
</style>
</head>

<body>
<div class="wrap">

<!-- 左 -->
<div class="panel">

<div class="grid3">
  <button onclick="setType('start')">スタート</button>
  <button onclick="setType('goal')">ゴール</button>
  <button onclick="runSim()">▶ 実行</button>
</div>

<h2>都市</h2>
<div class="grid6">
  <button onclick="setCity('涪州')">涪州</button>
  <button onclick="setCity('桂州')">桂州</button>
  <button onclick="setCity('永州')">永州</button>
  <button onclick="setCity('江州')">江州</button>
  <button onclick="setCity('光州')">光州</button>
  <button onclick="setCity('寿州')">寿州</button>
</div>

<h2>基本設定</h2>
<div class="grid3">
  <div class="field">
    <label>総距離</label>
    <input id="totalDist" value="50000000">
  </div>
  <div class="field">
    <label>基本速度</label>
    <input id="baseSpeed" value="1389">
  </div>
  <div class="field">
    <label>減少/秒</label>
    <input id="loss" value="100">
  </div>
</div>

<h2>結果</h2>
<div class="result">
  <div class="cell">位</div>
  <div class="cell">都市</div>
  <div class="cell">ライチ</div>
  <div class="cell">速度</div>
  <div class="cell">残距離</div>
  <div class="cell">時間</div>
</div>
<div id="result" class="result"></div>

</div>

<!-- 右 -->
<canvas id="field" width="900" height="1200"></canvas>

</div>

<script>
const canvas=document.getElementById('field');
const ctx=canvas.getContext('2d');

const cities=['涪州','桂州','永州','江州','光州','寿州'];
const colors={
  涪州:'#ff6b6b',
  桂州:'#ffd93d',
  永州:'#6bff95',
  江州:'#6ba8ff',
  光州:'#ff6bf0',
  寿州:'#6bfff5'
};

let nodes=[],currentType=null,currentCity=null;
let simRunning=false,simStart=0,simState={};

function setType(t){currentType=t}
function setCity(c){currentCity=c}

function addNode(x,y){
  if(!currentType||!currentCity) return;
  nodes.push({x,y,type:currentType,city:currentCity});
}

/* ===== ルート距離計算（マップ反映） ===== */
function routePx(city){
  const path=nodes.filter(n=>n.city===city);
  let px=0;
  for(let i=0;i<path.length-1;i++){
    px+=Math.hypot(path[i+1].x-path[i].x,path[i+1].y-path[i].y);
  }
  return px;
}

function runSim(){
  simState={};
  simRunning=true;
  simStart=performance.now();

  const allPx=cities.reduce((s,c)=>s+routePx(c),0)||1;

  cities.forEach(city=>{
    const px=routePx(city);
    const dist=px/allPx*(+totalDist.value);
    const speed=+baseSpeed.value;
    simState[city]={
      time:0,
      lychee:10600000,
      speed,
      remainDist:dist
    };
  });
}

function updateSim(){
  if(!simRunning) return;
  const now=performance.now();
  const dt=(now-simStart)/1000;
  simStart=now;

  cities.forEach(c=>{
    const s=simState[c];
    if(!s||s.remainDist<=0) return;
    s.remainDist=Math.max(0,s.remainDist-s.speed*dt);
    s.time+=dt;
    s.lychee=Math.max(0,s.lychee-(+loss.value)*dt);
  });
}

function drawResult(){
  const r=document.getElementById('result');
  r.innerHTML='';
  const rank=cities.slice().sort((a,b)=>simState[a].remainDist-simState[b].remainDist);
  rank.forEach((c,i)=>{
    const s=simState[c];
    const rate=s.lychee/10600000;
    r.innerHTML+=`
      <div class="cell">${i+1}</div>
      <div class="cell" style="color:${colors[c]}">${c}</div>
      <div class="cell">
        ${Math.floor(s.lychee).toLocaleString()}
        <div class="bar"><span style="width:${rate*100}%;background:${colors[c]}"></span></div>
      </div>
      <div class="cell">${s.speed.toFixed(0)}</div>
      <div class="cell">${Math.ceil(s.remainDist).toLocaleString()}</div>
      <div class="cell">${s.time.toFixed(0)}</div>
    `;
  });
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  nodes.forEach(n=>{
    ctx.fillStyle=colors[n.city];
    ctx.beginPath();
    ctx.arc(n.x,n.y,8,0,Math.PI*2);
    ctx.fill();
  });
  updateSim();
  if(simRunning) drawResult();
  requestAnimationFrame(draw);
}

canvas.onmousedown=e=>{
  if(simRunning) return;
  const r=canvas.getBoundingClientRect();
  addNode(e.clientX-r.left,e.clientY-r.top);
};

draw();
</script>
</body>
</html>
